<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./localize-behavior.html">
<link rel="import" href="./assessment-result-behavior.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="../s-html/s-html.html">
<link rel="import" href="../d2l-text-input/d2l-text-input.html">
<link rel="import" href="./siren-entity.html">


<dom-module id="d2l-rubric-editable-score">
	<template strip-whitespace>
		<style>
			:host {
				display: block;
			}
			d2l-text-input {
				max-width: 100px;
			}
			.score-out-of.assessed {
				color: var(--d2l-color-celestine);
			}
			.star {
				display: none;
				padding: 0 5px;
			}
			.score-out-of.assessed .star {
				display: inline;
			}
			.right {
				display: inline;
				padding: 0 5px;
			}
		</style>
		<siren-entity href="[[assessmentHref]]" token="[[token]]" entity="{{assessmentEntity}}"></siren-entity>
		<siren-entity href="[[criterionHref]]" token="[[token]]" entity="{{entity}}"></siren-entity>
		<div hidden="[[!_isEditingScore(criterionNum, editingScore)]]">
			<d2l-text-input
				id="text-area"
				value="[[getScore(entity, assessmentResult, totalScore)]]"
				type="number"
				step="any"
				min="0"
				max="100000"
			>
			</d2l-text-input>
			<div class="right">[[_localizeOutOf(entity)]]</div>
		</div>
		<div hidden="[[_isEditingScore(criterionNum, editingScore)]]" class$="[[_getOutOfClassName(scoreOverridden)]]">
			[[_localizeOutOf(entity, assessmentResult, totalScore)]]
			<div class="star" title="[[_localizeStarLabel(totalScore)]]">*</div>
		</div>
	</template>

	<script>
		Polymer({
			is: 'd2l-rubric-editable-score',

			properties: {
				criterionHref: String,

				/* Entity could be a criterionEntity or a rubricEntity */
				entity: Object,

				assessmentHref: {
					type: String,
					value: null
				},
				token: String,
				_boundBlurHandler: {
					type: Function,
					value: function() {
						return this._blurHandler.bind(this);
					}
				},

				/* For desktop criteria, this will be the criterion number.
				   For mobile and total score, this will be 1 for true, -1 for false */
				editingScore: {
					type: Number,
					value: -1,
					notify: true
				},
				oldScore: {
					type: Number
				},
				scoreOverridden: {
					type: Boolean,
					value: false
				},
				totalScore: {
					type: String,
					value: null
				},
				criterionNum: {
					type: Number,
					value: 1
				},
				readOnly: {
					type: Boolean,
					value: true
				}
			},

			behaviors: [
				D2L.PolymerBehaviors.Rubric.LocalizeBehavior,
				D2L.PolymerBehaviors.Rubric.AssessmentResultBehavior
			],

			observers: [
				'_onAssessmentResultChanged(entity, assessmentResult)'
			],

			_onAssessmentResultChanged: function(entity, assessmentResult) {
				if (!entity || !assessmentResult) {
					return;
				}

				if (this.totalScore) {
					this.scoreOverridden = this.isTotalScoreOverridden();
					return;
				}

				this.scoreOverridden = this.isScoreOverridden(this.criterionHref);
			},

			attached: function() {
				var elem = Polymer.dom(this.root).querySelector('d2l-text-input');
				if (!elem) {
					return;
				}
				elem.addEventListener('blur', this._boundBlurHandler);
			},

			detached: function() {
				var elem = Polymer.dom(this.root).querySelector('d2l-text-input');
				if (!elem) return;
				elem.removeEventListener('blur', this._boundBlurHandler);
			},

			focus: function() {
				var elem = Polymer.dom(this.root).querySelector('d2l-text-input');
				elem.focus();
			},

			_blurHandler: function(event) {
				this.editingScore = -1;
				var innerInput = event.target.$$('input');
				if (!innerInput || !innerInput.checkValidity()) {
					return;
				}
				var score = event.target.value;
				if (score === this.totalScore) {
					// score didn't change so don't override it
					return;
				}
				this._saveScore(score);
			},

			_saveScore: function(score) {
				if (this.criterionHref) {
					this.saveCriterionPoints(this.criterionHref, score);
				} else {
					this.saveTotalPoints(score);
				}
			},

			getScore: function(entity, assessmentResult, totalScore) {
				if (!entity || !assessmentResult) {
					return;
				}
				if (totalScore) {
					return totalScore;
				}
				return this.getAssessedScore(entity, assessmentResult);
			},

			_localizeOutOf: function(entity, assessmentResult, totalScore) {
				if (!entity || !entity.properties || !entity.properties.outOf) {
					return null;
				}

				var score = null;
				if (totalScore) {
					score = totalScore;
				} else if (assessmentResult) {
					score = this.getAssessedScore(entity, assessmentResult);
				}
				if (score || score === 0) {
					return this.localize('scoreOutOf', 'score', score.toString(), 'outOf', entity.properties.outOf.toString());
				}
				return this.localize('outOf', 'outOf', entity.properties.outOf.toString());
			},

			_getOutOfClassName: function(scoreOverridden) {
				var className = 'score-out-of';
				if (scoreOverridden && !this.readOnly) {
					className += ' assessed';
				}
				return className;
			},

			_isEditingScore: function(criterionNum, editingScore) {
				return criterionNum === editingScore;
			},

			_localizeStarLabel: function(totalScore) {
				if (totalScore) {
					return this.localize('overriddenTotalScoreTip');
				} else {
					return this.localize('overriddenScoreTip');
				}
			}
		});
	</script>
</dom-module>
