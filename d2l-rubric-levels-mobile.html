<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-fetch-siren-entity-behavior/d2l-fetch-siren-entity-behavior.html">
<link rel="import" href="../d2l-fetch/d2l-fetch.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">

<dom-module id="d2l-rubric-levels-mobile">
	<template>
		<style>
			:host{
				display:block;
			}
			.levels-container {
				display: inline-flex;
				height: 32px;
				width: 100%;
			}
			.levels {
				display: inline-flex;
				width: 100%;
			}
			.level {
				border: solid 1px var(--d2l-color-mica);
				display: flex;
				overflow: hidden;
				text-align: center;
				color: var(--d2l-color-galena);
			}
			.level:hover {
				cursor: pointer;
			}
			.level.selected {
				background-color: var(--d2l-color-regolith);
				border: solid 1px var(--d2l-color-galena);
				box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.1);
			}
			.level-name {
				@apply --d2l-body-small-text;
				white-space: nowrap;
				padding-left: 5px;
				padding-right: 5px;
			}
			.level-name.selected {
				font-weight: 700;
				color: var(--d2l-color-ferrite);
			}
			.level.last {
				border-top-right-radius: 6px;
				border-bottom-right-radius: 6px;
			}
			div.level:first-of-type {
				border-top-left-radius: 6px;
				border-bottom-left-radius: 6px;
			}
			.out-of {
				border-radius: 6px;
				width: 60px;
				min-width: 60px;
				margin-left: 15px;
				margin-right: 5px;
			}
			.out-of:hover {
				cursor: default;
			}
		</style>
		<div class="levels-container">
			<div class="levels">
				<template is="dom-repeat" items="[[_levelEntities]]">
					<div class$="[[_getLevelClassName(index, selected)]]" on-tap="_selectLevel" data-index="[[index]]">
						<div class$="[[_getLevelTextClassName(index, selected)]]">
							[[item.properties.name]]
						</div>
					</div>
				</template>
			</div>
			<template is="dom-if" if="[[_hasOutOf(outOf)]]">
				<div class="level out-of">
					<div class="level-name">
						&mdash; / [[outOf]]
					</div>
				</div>
			</template>
		</div>
	</template>
	<script>
		Polymer({
			is: 'd2l-rubric-levels-mobile',

			properties: {
				/**
				 * The href of the criteria group levels
				 */
				href: String,

				/**
				 * The user access token
				 */
				token: String,

				/**
				 * The total number of levels
				 */
				total: {
					type: Number,
					notify: true
				},

				/**
				 * The selected level
				 */
				selected: {
					type: Number,
					notify: true
				},

				/**
				 * The selected level name
				 */
				selectedName: {
					type: String,
					notify: true
				},

				/**
				 * The selected level points
				 */
				selectedPoints: {
					type: Number,
					notify: true
				},

				/**
				 * The maximum number of points for any level
				 */
				outOf: {
					type: Number
				},

				_levelEntities: Array
			},

			behaviors: [
				D2L.PolymerBehaviors.FetchSirenEntityBehavior,
				window.D2L.Hypermedia.HMConstantsBehavior
			],

			observers: [
				'_fetchEntity(href, token)',
				'_getSelectedProperties(_levelEntities, selected)'
			],

			_fetchEntity: function(href, token) {
				if (!href) {
					return;
				}
				this._fetchEntityWithToken(href, function() { return Promise.resolve(token); })
					.then(function(entity) {
						this.total = entity.properties.total;
						this._levelEntities = entity.getSubEntitiesByClass(this.HypermediaClasses.rubrics.level);
					}.bind(this));
			},

			_getSelectedProperties: function(levelEntities, selectedLevel) {
				if (!levelEntities) {
					return;
				}
				if (levelEntities[selectedLevel].properties.points) {
					this.selectedPoints = levelEntities[selectedLevel].properties.points;
				}
				this.selectedName = levelEntities[selectedLevel].properties.name;
			},

			_getLevelClassName: function(index, selected) {
				var className = 'level';
				if (index === selected) {
					className += ' selected';
				}
				if (index === this.total - 1) {
					className += ' last';
				}
				return className;
			},

			_getLevelTextClassName: function(index, selected) {
				if (index === selected) {
					return 'level-name selected';
				}
				return 'level-name';
			},

			_selectLevel: function(event) {
				this.selected = event.currentTarget.dataIndex;
			},

			_hasOutOf: function(outOf) {
				return !!outOf || outOf === 0;
			}
		});
	</script>
</dom-module>
