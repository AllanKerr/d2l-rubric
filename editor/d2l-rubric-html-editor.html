<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-html-editor/d2l-html-editor-client.html">
<link rel="import" href="../../d2l-html-editor/d2l-html-editor.html">
<link rel="import" href="../../d2l-inputs/d2l-input-shared-styles.html">

<dom-module id="d2l-rubric-html-editor">
	<template>
	<style include="d2l-input-styles">

		:host {
			display: flex;
			width: 100%;
		}

		d2l-html-editor {
			word-break: break-word;
			word-wrap: break-word;
			display: flex;
			width: 100%;
		}

		.d2l-richtext-editor-container {
			@apply --d2l-input;
			@apply --d2l-input-textarea;
			border-color: transparent;
			box-shadow: none;
			border-radius: 0;
			transition-property: none;
		}

		.d2l-richtext-editor-container:hover,
		.d2l-richtext-editor-container:focus,
		.d2l-richtext-editor-container:active,
		.d2l-richtext-editor-container.html-editor-container-hover {
			@apply --d2l-input-hover-focus;
		}

		d2l-html-editor.invalid > .d2l-richtext-editor-container {
			@apply --d2l-input-invalid;
		}

		/* .d2l-richtext-editor-container p {
		  margin: 1rem 0;
		} */
		d2l-html-editor .d2l-richtext-editor-container > p:last-of-type {
		  margin-bottom: 0;
		}

		d2l-html-editor .d2l-richtext-editor-container > p:first-of-type {
		  margin-top: 0;
		}
		/* .d2l-richtext-editor-container p:only-of-type {
		  margin: 0;
		} */

		d2l-html-editor.invalid > .d2l-richtext-editor-container:hover,
		d2l-html-editor.invalid > .d2l-richtext-editor-container:focus {
			@apply --d2l-input-invalid;
		}

		@media (max-width: 615px), (max-device-width: 960px) {
			d2l-html-editor > .d2l-richtext-editor-container {
				height: 3.9rem;
			}
		}
	</style>
	<d2l-html-editor editor-id=[[_uniqueId]]
					 inline="1"
					 auto-focus=[[autoFocus]]
					 auto-focus-end
					 min-rows="1"
					 max-rows="1000"
					 app-root=[[_appRoot]]
					 lang-tag=[[language]]
					 fullpage-enabled=0
					 content=[[_encodeURIComponent(initValue)]]
					 toolbar=[[_toolbar]]
					 plugins=[[_plugins]]
					 object-resizing=[[objectResizing]]>
	<div id$="[[_uniqueId]]-toolbar" class="toolbar"></div>
	<div id$="toolbar-shortcut-[[_uniqueId]]" hidden></div>
	<div class='d2l-richtext-editor-container'
		id=[[_uniqueId]]
		role="textbox"
		placeholder$=[[placeholder]]
		aria-label$=[[ariaLabel]]
		on-focus="_handleFocus"
		on-blur="_handleBlur"></div>
	</d2l-html-editor>
	</template>

	<script>
		Polymer({
			is: 'd2l-rubric-html-editor',
			properties: {
				language: {
					type: String,
				},
				/**
				* Every html editor element on a page MUST have a unique ID
				*/
				_uniqueId: {
					type: String,
					value: function() {
						return 'htmleditor-' + Date.now();
					},
				},
				ariaLabel: {
					type: String,
				},
				invalid: {
					type: Boolean,
					value: false,
					observer: '_invalidChanged',
				},
				inline: {
					type: Number,
					value: 1,
				},
				autoFocus: {
					type: Number,
					value: 0,
				},
				minRows: {
					type: Number,
					value: 1,
				},
				maxRows: {
					type: Number,
				},
				initValue: {
					type: String,
				},
				value: {
					type: String,
				},
				_appRoot: {
					type: String,
					value: function() {
						return this.resolveUrl('../');
					},
				},
				placeholder: {
					type: String,
				},
				_toolbar: {
					type: String,
					value: 'bold italic bullist',
				},
				_plugins: {
					type: String,
					value: 'lists paste d2l_placeholder d2l_filter',
				},
				objectResizing: {
					type: Boolean,
					value: false,
				},
			},
			attached: function() {
				Polymer.RenderStatus.afterNextRender(this, function() {
					this.listen(this.$$('d2l-html-editor'), 'change', '_contentChanged');
				}.bind(this));
			},
			detached: function() {
				this.unlisten(this.$$('d2l-html-editor'), 'change', '_contentChanged');
			},
			focus: function() {
				this.$$('d2l-html-editor').focus();
			},
			_getContent: function() {
				return this.$$('d2l-html-editor').getContent();
			},
			_invalidChanged: function(isInvalid) {
				var htmlEditor = this.$$('d2l-html-editor');
				this.toggleClass('invalid', isInvalid, htmlEditor);
			},
			_encodeURIComponent: function(value) {
				return value ? encodeURIComponent(value) : '';
			},
			_contentChanged: function(e) {
				// Stop change event from propagating as we instead fire a
				// 'change' event on an 'onBlur' to match the default behavior of TEXTAREAs.
				e.stopPropagation();
			},
			_handleFocus: function() {
				if (this.value === undefined || this.value === null) {
					this.value = this._getContent();
				}
			},
			_handleBlur: function(e) {
				var hasContentChanged = this._getContent() !== this.value;
				var emojiCausedBlur = e.relatedTarget && e.relatedTarget.hasAttribute('data-d2l-emoji');
				if (hasContentChanged && !emojiCausedBlur) {
					this.value = this._getContent();
					this.dispatchEvent(new CustomEvent(
						'change',
						{bubbles: true, composed: true}
					));
				}
			}
		});
	</script>
</dom-module>
