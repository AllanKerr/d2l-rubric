<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-inputs/d2l-input-textarea.html">

<link rel="import" href="./d2l-rubric-html-editor.html">

<dom-module id="d2l-rubric-text-editor">
	<template>
	<style>
		:host {
			line-height: 1rem;
			display: flex;

			--d2l-input-textarea: {

				min-height: 0;
				overflow: hidden;
				hyphens: auto;
			};
		}

		[hidden] {
			display: none;
		}

		* {
			box-sizing: border-box;
		}

	</style>
		<template is="dom-if" if="[[!enableHtmlEditor]]">
			<d2l-input-textarea
				id="textEditor"
				hidden$=[[enableHtmlEditor]]
				aria-invalid="[[ariaInvalid]]"
				aria-label="[[ariaLabel]]"
				disabled="[[disabled]]"
				no-border
				hover-styles
				value=[[value]]
				on-change="_onInputChange"
			></d2l-input-textarea>
		</template>
		<template is="dom-if" if="[[enableHtmlEditor]]">
			<d2l-rubric-html-editor
				id="htmlEditor"
				hidden$=[[!enableHtmlEditor]]
				aria-label=[[ariaLabel]]
				invalid=[[_stringIsTrue(ariaInvalid)]]
				language=[[language]]
				placeholder=[[placeholder]]
				value=[[value]]
				key=[[key]]
				min-rows=[[minRows]]
				max-rows=[[maxRows]]
				on-change="_onInputChange"
			></d2l-rubric-html-editor>
		</template>
	</template>

	<script>
		Polymer({
			is: 'd2l-rubric-text-editor',
			properties: {
				key: String,
				language: String,
				ariaLabel: {
					type: String,
				},
				ariaInvalid: {
					type: Boolean,
					value: false,
				},
				placeholder: {
					type: String,
				},
				value: {
					type: String,
					notify: true,
				},
				enableHtmlEditor: {
					type: Boolean,
					value: false,
				},
				disabled: {
					type: Boolean,
					value: false,
				}
			},
			focus: function() {
				if (this.enableHtmlEditor) {
					this.$$('#htmlEditor').focus();
				} else {
					this.$$('#textEditor').focus();
				}
			},
			_stringIsTrue: function(string) {
				return string && string === 'true';
			},
			_onInputChange: function(e) {
				e.stopPropagation();
				var value = (e.detail && e.detail.content) || e.target.value || '';
				if (this._decodeHtml(value) !== this._decodeHtml(this.value)) {
					this.debounce('fireInputChange', function() {
						this.fire('change', { value: value });
					}, 1000);

					var activeElementId = document.activeElement && document.activeElement.id;
					var focusedOnInput = activeElementId && e.target.querySelector('#' + activeElementId);
					// If it is a blur event (no longer focused on input), fire change event immediately to
					// avoid race conditions with other events.
					if (!focusedOnInput) {
						this.flushDebouncer('fireInputChange');
					}
				}
			},
			_decodeHtml: function(html) {
				if (!html) return '';
				var txt = document.createElement('textarea');
				txt.innerHTML = html;
				return txt.value;
			}
		});
	</script>
</dom-module>
