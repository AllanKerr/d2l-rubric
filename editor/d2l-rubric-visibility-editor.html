<link rel="import" href="../../polymer/polymer.html">

<link rel="import" href="../../d2l-colors/d2l-colors.html">
<link rel="import" href="../../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="../../iron-a11y-announcer/iron-a11y-announcer.html">
<link rel="import" href="../../d2l-tooltip/d2l-tooltip.html">
<link rel="import" href="../../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../../d2l-inputs/d2l-input-checkbox.html">
<link rel="import" href="../../d2l-polymer-siren-behaviors/store/siren-action-behavior.html">

<link rel="import" href="./../d2l-rubric-entity-behavior.html">
<link rel="import" href="./../localize-behavior.html">

<link rel="import" href="./d2l-rubric-error-handling-behavior.html">
<link rel="import" href="./d2l-input-radio-styles.html">

<dom-module id="d2l-rubric-visibility-editor">
	<template strip-whitespace>
		<style include="d2l-input-radio-styles">
			:host {
				display: block;
			}

			label {
				@apply --d2l-label-text;
			}
			.heading {
				display: block;
				margin-bottom: 0.5rem;
			}
			#visibility-group {
				display: inline-block;
			}
		</style>
		<label class="heading">[[localize('rubricVisibility')]]</label>
		<div id="visibility-group" aria-invalid$="[[isAriaInvalid(_visibilityInvalid)]]">
			<label class="d2l-input-radio-label">
				<input type="radio" id="AlwaysVisible" value="AlwaysVisible" name="visibility" on-change="_changeVisibility"></input>[[localize('rubricVisibilityAlways')]]
			</label>
			<label class="d2l-input-radio-label">
				<input type="radio" id="VisibleOnceFeedbackPosted" value="VisibleOnceFeedbackPosted" name="visibility" on-change="_changeVisibility"></input>[[localize('rubricVisibilityOnceFeedbackPosted')]]
			</label>
			<label class="d2l-input-radio-label">
				<input type="radio" id="NeverVisible" value="NeverVisible" name="visibility" on-change="_changeVisibility"></input>[[localize('rubricVisibilityNever')]]
			</label>
		</div>
		<template is="dom-if" if="[[_visibilityInvalid]]">
			<d2l-tooltip for="visibility-group" position="bottom">[[_visibilityInvalidError]]</d2l-tooltip>
		</template>
	</template>
	<script>
		Polymer({
			is: 'd2l-rubric-visibility-editor',
			properties: {
				/**
				* The href for this siren entity
				*/
				href: {
					type: String,
					reflectToAttribute: true
				},
				/**
				* The user access token
				*/
				token: {
					type: Object,
				},
				_selected: {
					type: String,
					observer: '_updateSelected'
				},
				_visibilityInvalid: {
					type: Boolean
				},
				_visibilityInvalidError: {
					type: String
				},
			},
			behaviors: [
				D2L.PolymerBehaviors.Rubric.EntityBehavior,
				D2L.PolymerBehaviors.Siren.SirenActionBehavior,
				window.D2L.Hypermedia.HMConstantsBehavior,
				D2L.PolymerBehaviors.Rubric.LocalizeBehavior,
				D2L.PolymerBehaviors.Rubric.ErrorHandlingBehavior,
			],
			_onEntityChanged: function(entity) {
				var action = entity && entity.getActionByName('update-visibility');
				if (action) {
					var field = action.getFieldByName('visibility');
					if (field && Array.isArray(field.value)) {
						for (var i = 0; i < field.value.length; i++) {
							if (field.value[i].selected) {
								this._selected = field.value[i].value;
							}
						}
					}
				}
			},
			_updateSelected: function(selected) {
				Polymer.dom(this.root).querySelector('#' + selected).checked = true;
			},
			_changeVisibility: function(e) {
				var action = this.entity.getActionByName('update-visibility');
				if (action) {
					var button = e.target;
					this.toggleBubble('_visibilityInvalid', false);
					var fields = [{ 'name': 'visibility', 'value': button.value }];
					this.performSirenAction(action, fields).then(function() {
						this.fire('d2l-rubric-visibility-saved');
					}.bind(this)).catch(function(err) {
						this.handleValidationError('_visibilityInvalid', 'changeVisibilityFailed', err);
					}.bind(this));
				}
			},
		});
	</script>
</dom-module>
